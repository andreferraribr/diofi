---
title: "DIOFI-GRA-SC"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    source_code: https://github.com/andreferraribr/diofi
    social: [ "twitter", "facebook", "menu" ]
  

runtime: shiny
---


```{r setup, include=FALSE}
options(scipen=999)
options(digits=2)
```


```{r, message=FALSE}
library(flexdashboard)
library(readxl)
library(ggplot2)
library(stringr)
library(plotly)
library(DT)
library(knitr)
library(shiny)
library(shinyWidgets)
library(lubridate)
library(tidyverse)
library(janitor)
library("microbenchmark")
# library("ggplot2movies")
library("profvis")
# library("Rcpp")



```

```{r}
# profvis({  
```


```{r}
'%!in%' <- Negate('%in%')
```

```{r}

# funcao para importar dados e renomear variaveis

dados = function(tg, depara){
  # carregar planilha com dados do Tesouro Gerencial (tg)
  df <- read_xlsx(tg)
  # carregar planilha com o de_para dos nomes dos atributos do Tesouro Gerencial para nomes mais amigáveis para as variáveis. Por exemplo, de(Unidade Orçamentária Código) para(uo_cod)
  tg2r <- read_xlsx(depara)
  # renomear as colunas da df fazendo o de_para
  colnames(df)<-tg2r$r_name
  return(df)
}
```

```{r}

# comentar funcao e parametro para totalizar colunas e linhas
# ajustar formatacao de acordo com a opcao de totalizar
# criar forma melhor para selecionar apenas colunas numericas para formatacao de valor
# coluna = "Total" para totalizar columnwise
tabela = function (df,coluna = NULL) {
      datatable((df)%>%
  adorn_totals("row") ,
      filter = 'top',          
      extensions = 'Buttons',
      options = list( 
                  # order = list (df[(length(df))], 'desc'),
                  dom = "Blfrtip",
                  buttons = 
                    list("copy", list(
                      extend = "collection",
                      buttons = c("csv", "excel", "pdf"),
                      text = "Download" ) ),
                  lengthMenu = list( c(-1, 5, 10,20),
                                     c( "tudo",5, 10, 20)),
                  pageLength = 10 )
      )%>%
  formatRound(
  # formatar apenas as colunas numericas.
  # sapply para identificar as colunas numericas e combinar com o parametro COLUNA
    # ((ncol(df %>% select_if(is.character))+1):(ncol(df )+1)),
    # http://datamining.togaware.com/survivor/Remove_Non_Numeric.html
    (c(colnames(df[,sapply(df, is.numeric)]), coluna)),
  digits = 2,
  interval = 3,
  mark = ",",
  dec.mark = getOption("OutDec")
)
}
```



```{r}
reais <- function(numero){
  paste0("R$ ",round(numero/1000,digits = 1), " K")
}
```


```{r include=FALSE}

#  importar relatório gerado no Tesouro Gerencial com dados sobre o crédito disponível e renomear as colunas
credito <- dados("r_credito.xlsx", "tg2r_credito.xlsx")


# criar a variável ug_cliente para apurar os saldos entre a ug 170166 e a setorial 170013
credito<- credito%>%
  mutate ( ug_ug = if_else(ug_emit_cod %in% c("170166", "170013"),str_c(ug_emit_cod,favorecido_cod,ug_emit,favorecido),""))%>%
  mutate (ug_cliente = str_replace(ug_ug, "SUPERINTENDENCIA DE ADMINISTRACAO DO MF/SC",""))%>%
  mutate (ug_cliente = str_replace(ug_cliente, "170166",""))





```


```{r}
# limite <- dados("r_limite.xlsx", "tg2r_limite.xlsx")
```

```{r}
# repasse <- dados("r_repasse.xlsx", "tg2r_repasse.xlsx")
```



```{r}



#  importar relatório gerado no Tesouro Gerencial com dados sobre o custos e renomear as colunas
custos <- dados("r_custos.xlsx", "tg2r_custos.xlsx")


custos <- custos %>% mutate (
  mes = ymd (paste0(custos$mm_ano_cod,"01")),
  # mes_nome = month(mes, label = TRUE ,locale = "pt_BR.UTF-8")) %>% 
  mes_nome = month(mes, label = TRUE )) %>% 
  mutate (chave = paste0(favorecido, mm_ano_cod))




custos <- custos %>% mutate(org = case_when(
  centro_custo_cod == "S6SC002MCTI" ~ "MCTIC",
  centro_custo_cod == "S6SC001ABIN" ~ "ABIN",
  centro_custo_cod == "S6SC001INPI" ~ "INPI",
  centro_custo_cod == "S6SC003CGU"  ~ "CGU",
  centro_custo_cod == "S612SC001"   ~ "GRA",
  centro_custo_cod == "S612SC002"   ~ "GRA",
  centro_custo_cod == "S612SC003"   ~ "GRA",
  centro_custo_cod == "S672SC003"   ~ "SPU",
  centro_custo_cod == "S621SC003"   ~ "PFN",
  TRUE  ~ "outras localidades"
    
  )
)


custos <- custos %>% mutate(org_custo = case_when(
  centro_custo_cod == "S6SC002MCTI" ~ "MCTIC",
  centro_custo_cod == "S6SC001ABIN" ~ "ABIN",
  centro_custo_cod == "S6SC001INPI" ~ "INPI",
  centro_custo_cod == "S6SC003CGU"  ~ "CGU",
  centro_custo_cod == "S612SC001"   ~ "GRA",
  centro_custo_cod == "S612SC002"   ~ "GRA",
  centro_custo_cod == "S612SC003"   ~ "GRA",
  centro_custo_cod == "S672SC003"   ~ "GRA",
  centro_custo_cod == "S621SC003"   ~ "GRA",
  TRUE  ~ "outras orgs"
    
  )
)



custos <- custos %>% mutate(org_pago = case_when(
  uo_cod == "24101" ~ "MCTIC",
  uo_cod == "20118" ~ "ABIN",
  uo_cod == "25297" ~ "INPI",
  uo_cod == "37101"  ~ "CGU",
  uo_cod == "25101"   ~ "GRA",
  TRUE  ~ "outras uos"
    
  )
)


gra <- c("S6SC002MCTI", "S6SC001ABIN", "S6SC001INPI", "S6SC003CGU", "S612SC001", "S612SC002", "S612SC003", "S672SC003", "S621SC003" ) 

rateio <- c("05027397000129", "05600954000159","08336783000190","10364152000127","78533312000158","82508433000117","82892282000143")



custo_mensal_gra <- custos %>% filter (centro_custo_cod %in% gra) %>%  group_by(ndd, mes_nome) %>% summarise(custo = sum(custo)) %>% pivot_wider( names_from = mes_nome, values_from = custo) %>% mutate_all(~replace(., is.na(.), 0))




rateio_gra <- custos %>% filter (org != "outras localidades", favorecido_cod %in% rateio) %>%  group_by(org , mes_nome) %>% summarise(custo = sum(custo)) %>% pivot_wider( names_from = mes_nome, values_from = custo) %>% mutate_all(~replace(., is.na(.), 0))



saldo_org <- custos %>% filter (centro_custo_cod %in% gra, favorecido_cod %in% rateio) %>%  group_by(org_custo) %>% summarise(custo = sum(custo)) 

saldo_uo <- custos %>% filter (centro_custo_cod %in% gra, favorecido_cod %in% rateio) %>%  group_by(org_pago) %>% summarise(pago = sum(custo)) 

saldo_custo <- full_join(saldo_org,saldo_uo, by = c ("org_custo" = "org_pago")) %>% mutate_all(~replace(., is.na(.), 0))%>% mutate(saldo = pago - custo)
  

 
custo_mensal_rateio <- custos %>% filter (org_custo == "GRA") %>%  group_by(favorecido, mes_nome) %>% summarise(custo = sum(custo)) %>% pivot_wider( names_from = mes_nome, values_from = custo) %>% mutate_all(~replace(., is.na(.), 0))

# custo_pago <- custos %>% filter(org_custo == "GRA") %>% summarise(custo = sum(custo))




```
```{r}
projetado <- read_xlsx("projetado.xlsx") 

projetado <- projetado %>% pivot_longer(starts_with("2020"),names_to = "mm_ano_cod", values_to = "custo") %>% mutate (mm_ano_cod = as.character(as.integer(mm_ano_cod)))%>% mutate (
  mes = ymd (paste0(projetado$mm_ano_cod,"01")),
  mes_nome = month(mes, label = TRUE)) %>% 
  mutate (chave = paste0(favorecido, mm_ano_cod))

projetado <- projetado %>% mutate (
  mes = ymd (paste0(projetado$mm_ano_cod,"01")),
  mes_nome = month(mes, label = TRUE))


realizado <- custos %>% filter ( org_custo == "GRA") %>% group_by(favorecido, favorecido_cod, mm_ano_cod, mes, mes_nome, chave) %>% summarise(custo = sum (custo))%>% mutate_all(~replace(., is.na(.), 0))

monitorado <- na.omit(anti_join(projetado, realizado, by = "chave") )

teste <- na.omit( rbind(monitorado, realizado))
```


```{r}
# balancete <- dados ("balancete.xlsx", "tg2r_balancete.xlsx")

orcado <- read_xlsx("orcado.xlsx")
```



Custos GRA
=============================================


Row {data-height=20}
-----------------------------------------------------------------------


### limite orcarmentario

```{r}


sliderInput(inputId = "limite", label = "limite", min= 400000, max = 750000, value = 680000, step = NULL, round = FALSE,
  format = NULL, locale = NULL, ticks = TRUE, animate = FALSE,
  width = NULL, sep = ",", pre = NULL, post = NULL, timeFormat = NULL,
  timezone = NULL, dragRange = TRUE)
```

### custos pagos

```{r}
flexdashboard::renderValueBox({
  
    
    valueBox(
    reais(sum(realizado$custo)),
    color = "black"
    )
  })
```


### custos a pagar (estimado)

```{r}
flexdashboard::renderValueBox({
  
    
    valueBox(
    reais(sum(monitorado$custo)),
    color = "grey"
    )
  })
```



### saldo orçamentário (estimado)

```{r}
flexdashboard::renderValueBox({
  
    value <- input$limite - sum(monitorado$custo)- sum(realizado$custo)    
    valueBox(
    reais(value),
    color = if_else(value > 0, "blue", "red")
    )
  })
```



Row
--------------------------------------------------------------------------



### custos da GRA

```{r}


renderDT({
tabela(custos %>% filter (org_custo == "GRA") %>%  group_by(favorecido, mes_nome) %>% summarise(custo = sum(custo)) %>% pivot_wider( names_from = mes_nome, values_from = custo) %>% mutate_all(~replace(., is.na(.), 0))
%>%
  adorn_totals("col"),"Total")
})


```


### projeção

```{r}
renderPlotly({
  # criar df_br para consolidar custo mês a mês.
 df_br<-teste %>% group_by(mes) %>% summarise(custo = sum(custo))
  
 
  
 historico<- ggplot( df_br, aes(  x= mes , y=cumsum(custo))) +
    # geom_line(color =if_else((df_br$mes ) <= max(realizado$mes),  "black", "grey"))+
   geom_line(aes(linetype =if_else(max(realizado$mes) >= (df_br$mes ) ,  "dashed", "solid")))+
    # geom_line(aes(  x= mes , y=cumsum(projetado$custo)), colour = "grey", linetype = "dashed") +
  geom_hline(yintercept=input$limite, colour = "red", linetype = "dashed") +
   geom_segment(aes(x = max(mes), y = sum(teste$custo), xend = max(mes), yend = input$limite),
                color = if_else(input$limite> sum(teste$custo),"blue","red")) +
   # https://mariano.eng.br/erro-cannot-set-lc-all-to-default-locale/
   # https://stackoverflow.com/questions/43099990/r-lubridate-weekdays-in-local-language
    annotate("text", label = paste0 ("custos pagos até ", month(max(realizado$mes), label = TRUE, abbr = FALSE),": ", reais (sum(realizado$custo))),
             x = max(realizado$mes)+ 30, 
             y = sum(realizado$custo) + 10000, size = 4,
             colour = "black")+   
    annotate("text", label = paste0 ("saldo orçamentário: ", reais (input$limite-sum(teste$custo))),
             x = max(teste$mes)-60, 
             y = input$limite- (input$limite-sum(teste$custo))/2, size = 4,
             colour = if_else(input$limite> sum(teste$custo),"blue","red"))+
    theme_classic() +
    ylab("") +
    xlab("") +
    theme(axis.text.x = element_text(size=8),
          axis.text.y = element_text(size=8),
          legend.position = "none")
  
ggplotly(historico  )   
})
```

Crédito
=============================================




### CREDITO ÓRGÃOS
```{r}

renderDT({
tabela (credito %>%   group_by(uo, ugr) %>% summarise(credito = sum(saldo)))
  
  })
```



### SALDO DE CUSTOS

```{r}

renderDT({
tabela (saldo_custo)
  
  })

```


### CRÉDITO GRA
```{r}

renderDT({
tabela (credito %>%  filter(ugr_cod == "170166") %>% group_by(nd_cod, pi) %>% summarise(credito = sum(saldo)))
  
  })
```





```{r eval=FALSE, include=FALSE}

renderPlotly({
  
  plot_gra<-custos %>% filter (centro_custo_cod %in% gra) %>%  group_by(mes) %>% summarise(custo = (sum(custo)))
  
  gra<- ggplot( plot_gra, aes(  x= mes  , y=custo)) +
    geom_line()
  
ggplotly(gra)  
})

```




Rateio
=============================================
Row
--------------------------------------------------------------------------

### rateio por fornecedor

```{r}
renderDT({
tabela(custos %>% filter (org != "outras localidades", favorecido_cod %in% rateio) %>%  group_by(favorecido, mes_nome) %>% summarise(custo = sum(custo)) %>% pivot_wider( names_from = mes_nome, values_from = custo) %>% mutate_all(~replace(., is.na(.), 0))%>%
  adorn_totals("col"),"Total"
) 
})
```

Row
--------------------------------------------------------------------------

### rateio por órgão

```{r}
# https://stackoverflow.com/questions/4946873/add-row-to-a-data-frame-with-total-sum-for-each-column

renderDT({
tabela(custos %>% filter (org != "outras localidades", favorecido_cod %in% rateio) %>%  group_by(org, mes_nome) %>% summarise(custo = sum(custo)) %>% pivot_wider( names_from = mes_nome, values_from = custo) %>% mutate_all(~replace(., is.na(.), 0))%>%
  adorn_totals("col"),"Total")
  
})
```

```{r}
# })
```



```{r eval=FALSE, include=FALSE}
renderPlotly({
df_br<-monitorado %>% group_by(mes, favorecido) %>% summarise(custo = sum(custo))

teste <- ggplot(df_br, aes(mes, favorecido, fill= custo)) + 
  geom_tile() +
  scale_fill_gradient(low="grey", high="red")+
  theme_classic()
ggplotly(teste)
})
```



```{r eval=FALSE, include=FALSE}
datatable(( custos %>% filter (centro_custo_cod %in% gra, favorecido_cod %in% rateio) %>%  group_by(doc_habil, mes) %>% summarise(q = n())) %>% filter(q == 7))

np_audit <- custos %>% filter (centro_custo_cod %in% gra, favorecido_cod %in% rateio) %>%  group_by(doc_habil, mes) %>% summarise(q = n()) %>% filter(q == 7)

audit <- custos %>% filter (doc_habil %in% np_audit$doc_habil)
```

```{r}
```

